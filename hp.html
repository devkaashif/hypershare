<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Core Sharing — simple snippet share</title>
  <style>
    /* Minimal, self-contained styling so it won't affect other pages when embedded */
    :root{ --bg:#0f1724; --card:#0b1220; --muted:#9aa4b2; --accent:#4f46e5; --success:#16a34a; --danger:#ef4444; --glass: rgba(255,255,255,0.03)}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;color:#e6eef6;background:linear-gradient(180deg,#071226 0%, #071429 100%);display:flex;align-items:center;justify-content:center;padding:20px}
    .wrap{width:100%;max-width:980px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    h1{margin:0;font-size:20px}
    .grid{display:grid;grid-template-columns:1fr 360px;gap:16px}
    .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 6px 18px rgba(2,6,23,0.6)}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input[type="text"], select, textarea{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:var(--glass);color:inherit;resize:vertical}
    textarea{min-height:180px;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace;font-size:13px}
    button{padding:10px 12px;border-radius:10px;border:0;background:var(--accent);color:white;cursor:pointer}
    .muted{color:var(--muted);font-size:13px}
    .list{max-height:420px;overflow:auto;margin-top:12px}
    .item{padding:10px;border-radius:8px;margin-bottom:8px;background:rgba(255,255,255,0.02);display:flex;align-items:center;justify-content:space-between;gap:8px}
    .smallbtn{padding:6px 8px;border-radius:8px;border:0;background:#0ea5a0;color:white;cursor:pointer;font-size:13px}
    .danger{background:var(--danger)}
    .meta{font-size:12px;color:var(--muted)}
    .note{font-size:13px;color:var(--muted);margin-top:10px}
    footer{margin-top:14px;text-align:center;color:var(--muted);font-size:13px}
    @media(max-width:880px){ .grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Core Sharing — Snippet Share</h1>
      <div class="muted">Simple Firestore-based shareable snippets</div>
    </header>

    <div class="grid">
      <!-- Left: editor/list -->
      <div class="card">
        <div>
          <label for="title">Title</label>
          <input id="title" placeholder="Short title (e.g. My App config)" />
        </div>

        <div style="margin-top:10px">
          <label for="lang">Language / Type</label>
          <select id="lang">
            <option>text</option>
            <option>javascript</option>
            <option>html</option>
            <option>css</option>
            <option>json</option>
            <option>bash</option>
          </select>
        </div>

        <div style="margin-top:10px">
          <label for="content">Content</label>
          <textarea id="content" placeholder="Paste your core snippet here..."></textarea>
        </div>

        <div style="display:flex;gap:8px;margin-top:10px;align-items:center">
          <button id="saveBtn">Save & generate link</button>
          <button id="clearBtn" style="background:#111827">Clear</button>
          <div id="status" class="muted" style="margin-left:8px"></div>
        </div>

        <div class="note">Saved snippets are public. Delete is allowed only if you know the internal owner token (stored in localStorage) created on save.</div>

        <section style="margin-top:14px">
          <label>Recent snippets</label>
          <div id="list" class="list"></div>
        </section>
      </div>

      <!-- Right: view/share -->
      <div class="card">
        <div id="viewer">
          <label>Open by share ID (from link)</label>
          <div style="display:flex;gap:8px">
            <input id="openId" placeholder="paste SHAREID or open via URL param" />
            <button id="openBtn" class="smallbtn">Open</button>
          </div>

          <div id="snippetCard" style="margin-top:12px;display:none">
            <div style="display:flex;justify-content:space-between;align-items:start">
              <div>
                <div id="sTitle" style="font-weight:600"></div>
                <div id="sMeta" class="meta"></div>
              </div>
              <div style="display:flex;gap:8px">
                <button id="copyLink" class="smallbtn">Copy link</button>
                <button id="deleteBtn" class="smallbtn danger">Delete</button>
              </div>
            </div>
            <pre id="sContent" style="white-space:pre-wrap;margin-top:10px;padding:8px;border-radius:8px;background:rgba(0,0,0,0.25);font-family:ui-monospace,monospace;font-size:13px"></pre>
          </div>
        </div>

        <footer>
          <div class="meta">Built with Firestore (client-side). Not for secret keys. Use only public snippets.</div>
        </footer>
      </div>
    </div>
  </div>

  <!-- Firebase v9 compat CDN scripts -->
  <!-- Using compat CDN lets us run without bundlers while using Firestore. See Firebase docs. -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
  // ---------- Replace or confirm: your Firebase config (already provided) ----------
  const firebaseConfig = {
    apiKey: "AIzaSyD0T-mS__FlN3QASJnmD0K6S5VNDiN2bxQ",
    authDomain: "poplol-7209f.firebaseapp.com",
    projectId: "poplol-7209f",
    storageBucket: "poplol-7209f.firebasestorage.app",
    messagingSenderId: "1058108342269",
    appId: "1:1058108342269:web:577700a7503b3db8316394",
    measurementId: "G-EXR6CPBH5R"
  };

  // Initialize Firebase & Firestore (compat style)
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Helpers
  const $ = id => document.getElementById(id);
  const makeId = (len=8) => {
    const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let r=''; for(let i=0;i<len;i++) r += chars[Math.floor(Math.random()*chars.length)];
    return r;
  };

  // Local owner token mechanism: generated at save and stored in localStorage;
  // allows deletion only if token matches. This is a minimal client-side protection.
  const OWNER_TOKEN_KEY = 'core_sharing_owner_token';

  // Save snippet
  $('saveBtn').addEventListener('click', async () => {
    const title = $('title').value.trim() || 'Untitled';
    const language = $('lang').value || 'text';
    const content = $('content').value.trim();
    if (!content) { setStatus('Please add content before saving', true); return; }

    setStatus('Saving...');
    try {
      const shareId = makeId(10);
      const ownerToken = localStorage.getItem(OWNER_TOKEN_KEY) || makeId(24);
      localStorage.setItem(OWNER_TOKEN_KEY, ownerToken);

      const doc = {
        title,
        language,
        content,
        shareId,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        ownerToken
      };
      // write to collection "snippets", store doc with custom shareId as field but let Firestore auto-id the doc
      await db.collection('snippets').add(doc);

      const link = buildShareLink(shareId);
      setStatus('Saved. Link ready.');
      showSavedLink(link);
      loadRecent(); // refresh list
    } catch (err) {
      console.error(err);
      setStatus('Save failed: '+err.message, true);
    }
  });

  // Clear button
  $('clearBtn').addEventListener('click', () => {
    $('title').value = '';
    $('content').value = '';
    $('lang').value = 'text';
    setStatus('');
  });

  // Build share URL (uses current page origin + ?id=)
  function buildShareLink(shareId) {
    return location.origin + location.pathname + '?id=' + encodeURIComponent(shareId);
  }

  // Show saved link in the 'openId' box for quick copy
  function showSavedLink(link) {
    $('openId').value = link;
    // auto-select so user can copy quickly
    $('openId').select();
  }

  function setStatus(text, isError=false) {
    const s = $('status');
    s.textContent = text||'';
    s.style.color = isError ? 'var(--danger)' : 'inherit';
  }

  // Load recent snippets (simple query: last 20 ordered by createdAt desc)
  async function loadRecent(){
    const container = $('list');
    container.innerHTML = '';
    try {
      const q = await db.collection('snippets').orderBy('createdAt','desc').limit(20).get();
      if (q.empty) { container.innerHTML = '<div class="muted">No snippets yet</div>'; return; }
      q.forEach(doc => {
        const data = doc.data();
        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `
          <div style="min-width:0">
            <div style="font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${escapeHtml(data.title||'Untitled')}</div>
            <div class="meta">${escapeHtml(data.language||'text')} • ${data.shareId || ''}</div>
          </div>
          <div style="display:flex;gap:6px;align-items:center">
            <button class="smallbtn" data-share="${data.shareId}">Open</button>
          </div>
        `;
        container.appendChild(div);
      });

      // attach open handlers
      container.querySelectorAll('button[data-share]').forEach(btn=>{
        btn.addEventListener('click', ()=> openByShareId(btn.dataset.share));
      });

    } catch(e){
      container.innerHTML = '<div class="muted">Failed to load recent</div>';
      console.error(e);
    }
  }

  // Open snippet by shareId
  async function openByShareId(shareIdOrLink){
    let id = shareIdOrLink || $('openId').value.trim();
    // If the user pasted full URL, extract id parameter
    try {
      const url = new URL(id, location.href);
      if (url.searchParams.get('id')) id = url.searchParams.get('id');
    } catch(e) { /*not a url*/ }

    if (!id) { setStatus('Provide a share id or link', true); return; }
    setStatus('Loading...');
    try {
      const q = await db.collection('snippets').where('shareId','==',id).limit(1).get();
      if (q.empty) { setStatus('Snippet not found', true); showSnippet(null); return; }
      const doc = q.docs[0];
      const data = doc.data();
      showSnippet({ docId: doc.id, data });
      setStatus('');
    } catch(e){
      setStatus('Open failed: '+e.message, true);
      console.error(e);
    }
  }

  function showSnippet(obj) {
    const card = $('snippetCard');
    if (!obj){ card.style.display='none'; return; }
    card.style.display='block';
    $('sTitle').textContent = obj.data.title || 'Untitled';
    const created = obj.data.createdAt && obj.data.createdAt.toDate ? obj.data.createdAt.toDate().toLocaleString() : '';
    $('sMeta').textContent = (obj.data.language || 'text') + (created ? ' • ' + created : '') + ' • ' + (obj.data.shareId || '');
    $('sContent').textContent = obj.data.content || '';
    $('openId').value = obj.data.shareId || '';
    $('copyLink').onclick = () => {
      const link = buildShareLink(obj.data.shareId);
      navigator.clipboard.writeText(link).then(()=> {
        setStatus('Link copied to clipboard');
      }, ()=> setStatus('Copy failed', true));
    };

    $('deleteBtn').onclick = async () => {
      // Only allow deletion if ownerToken in doc matches localStorage
      const localToken = localStorage.getItem(OWNER_TOKEN_KEY);
      if (!localToken) { setStatus('You are not the owner (no token in this browser)', true); return; }
      if (obj.data.ownerToken !== localToken) {
        setStatus('Owner token mismatch. Delete not allowed from this browser.', true);
        return;
      }
      if (!confirm('Delete this snippet? This cannot be undone.')) return;
      try {
        await db.collection('snippets').doc(obj.docId).delete();
        setStatus('Deleted');
        showSnippet(null);
        loadRecent();
      } catch (e) {
        setStatus('Delete failed: ' + e.message, true);
      }
    };
  }

  // Utility: small HTML escape
  function escapeHtml(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  // Wiring open button
  $('openBtn').addEventListener('click', ()=> openByShareId());

  // On page load: try to open id param and load recent
  (function init(){
    loadRecent();
    const params = new URLSearchParams(location.search);
    if (params.has('id')) {
      openByShareId(params.get('id'));
    }
  })();

  </script>
</body>
</html>
